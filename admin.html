<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * { font-family: 'Prompt', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #f5f5f5; }
        
        .header {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            padding: 25px 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 1em;
            color: #555;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #4CAF50;
            color: white;
            font-weight: 600;
        }
        
        .tab-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h2 {
            color: #333;
            margin-bottom: 25px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group {
            margin-bottom: 25px;
        }
        
        input, select {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            margin-bottom: 15px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus {
            border-color: #4CAF50;
            outline: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }
        
        .result {
            margin-top: 25px;
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        
        .success {
            background: #E8F5E9;
            color: #2E7D32;
            border: 1px solid #C8E6C9;
            display: block;
        }
        
        .error {
            background: #FFEBEE;
            color: #C62828;
            border: 1px solid #FFCDD2;
            display: block;
        }
        
        .customer-card {
            background: #f8f9fa;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 5px solid #4CAF50;
        }
        
        .transaction-card {
            background: #f8f9fa;
            padding: 18px;
            margin: 12px 0;
            border-radius: 10px;
            border-left: 5px solid;
        }
        
        .transaction-earn { border-left-color: #4CAF50; }
        .transaction-redeem { border-left-color: #FF9800; }
        
        .back-btn {
            display: inline-block;
            margin-top: 20px;
            padding: 12px 25px;
            background: #2196F3;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }
        
        .stat-card {
            background: #E3F2FD;
            padding: 25px 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2.2em;
            font-weight: 700;
            color: #1976D2;
        }
        
        .stat-label {
            color: #546E7A;
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè™ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h1>
        <p>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡πÅ‡∏•‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</p>
    </div>
    
    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('add')">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            <button class="tab" onclick="showTab('redeem')">üéÅ ‡πÅ‡∏•‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏©</button>
            <button class="tab" onclick="showTab('customers')">üë• ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button class="tab" onclick="showTab('transactions')">üìà ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</button>
            <button class="tab" onclick="showTab('stats')">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</button>
        </div>
        
        <!-- ‡πÅ‡∏ó‡πá‡∏ö 1: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -->
        <div id="add" class="tab-content active">
            <h2>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠</h2>
            <div class="input-group">
                <input type="text" id="phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô 0812345678)" required>
                <input type="number" id="amount" placeholder="‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ö‡∏≤‡∏ó)" step="0.01" min="1" required>
                <button class="btn" onclick="addPoints()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            </div>
            <div id="resultAdd" class="result"></div>
        </div>
        
        <!-- ‡πÅ‡∏ó‡πá‡∏ö 2: ‡πÅ‡∏•‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏© -->
        <div id="redeem" class="tab-content">
            <h2>üéÅ ‡πÅ‡∏•‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏©</h2>
            <div class="input-group">
                <input type="text" id="redeemPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" required>
                <select id="privilegeSelect">
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏©...</option>
                </select>
                <button class="btn" onclick="redeemPoints()">‡πÅ‡∏•‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏©</button>
            </div>
            <div id="resultRedeem" class="result"></div>
        </div>
        
        <!-- ‡πÅ‡∏ó‡πá‡∏ö 3: ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
        <div id="customers" class="tab-content">
            <h2>üë• ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
            <input type="text" id="searchCustomer" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£..." 
                   oninput="searchCustomers()" style="margin-bottom: 20px;">
            <div id="customerList"></div>
        </div>
        
        <!-- ‡πÅ‡∏ó‡πá‡∏ö 4: ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° -->
        <div id="transactions" class="tab-content">
            <h2>üìà ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="text" id="searchTransaction" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£..." 
                       oninput="searchTransactions()" style="flex: 3;">
                <select id="transactionType" onchange="searchTransactions()" style="flex: 1;">
                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    <option value="earn">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</option>
                    <option value="redeem">‡πÅ‡∏•‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</option>
                </select>
            </div>
            <div id="transactionList"></div>
        </div>
        
        <!-- ‡πÅ‡∏ó‡πá‡∏ö 5: ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ -->
        <div id="stats" class="tab-content">
            <h2>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <div class="stats" id="statsContainer"></div>
            <h3 style="margin-top: 30px;">üìã ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
            <div id="recentTransactions"></div>
        </div>
        
        <a href="index.html" class="back-btn">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
    </div>

    <script>
        // ‚≠ê ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‚≠ê
        const SUPABASE_URL = 'https://ioclbvoguugkdmsvvjhe.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvY2xidm9ndXVna2Rtc3Z2amhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjMwMTksImV4cCI6MjA4MjM5OTAxOX0.5Y7hC2k9mdmG-3hysYixOxf8flT9zGZT_vc2qa7ETaE';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ Admin System Ready');
            loadPrivileges();
            loadStats();
        });
        
        // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ó‡πá‡∏ö
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'customers') loadCustomers();
            if (tabName === 'transactions') loadTransactions();
            if (tabName === 'stats') loadStats();
            if (tabName === 'redeem') loadPrivileges();
        }
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        async function addPoints() {
            const phone = document.getElementById('phone').value.trim();
            const amount = parseFloat(document.getElementById('amount').value);
            
            if (!phone || !amount || amount <= 0) {
                showResult('resultAdd', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', false);
                return;
            }
            
            try {
                const { data, error } = await supabase.rpc('add_customer_points', {
                    p_customer_phone: phone,
                    p_amount: amount
                });
                
                if (error) throw error;
                
                if (data && data.success) {
                    showResult('resultAdd', 
                        `‚úÖ ${data.message}<br>
                         üë§ <strong>${data.customer_name}</strong><br>
                         üí∞ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: <strong>${amount} ‡∏ö‡∏≤‡∏ó</strong><br>
                         ‚≠ê ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <strong>${data.points_added} ‡πÅ‡∏ï‡πâ‡∏°</strong><br>
                         üìä ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: <strong>${data.total_points} ‡πÅ‡∏ï‡πâ‡∏°</strong>`, 
                        true);
                    
                    document.getElementById('phone').value = '';
                    document.getElementById('amount').value = '';
                } else {
                    showResult('resultAdd', '‚ùå ' + (data?.message || '‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'), false);
                }
            } catch (err) {
                showResult('resultAdd', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, false);
            }
        }
        
        // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏©
        async function loadPrivileges() {
            try {
                const { data, error } = await supabase
                    .from('privileges')
                    .select('*')
                    .eq('is_active', true)
                    .order('points_required');
                
                if (error) throw error;
                
                const select = document.getElementById('privilegeSelect');
                select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏©...</option>';
                
                data.forEach(priv => {
                    const option = document.createElement('option');
                    option.value = priv.id;
                    option.textContent = `${priv.name} (${priv.points_required} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)`;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('Error loading privileges:', err);
            }
        }
        
        // ‡πÅ‡∏•‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        async function redeemPoints() {
            const phone = document.getElementById('redeemPhone').value.trim();
            const privilegeId = document.getElementById('privilegeSelect').value;
            
            if (!phone || !privilegeId) {
                showResult('resultRedeem', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', false);
                return;
            }
            
            try {
                const { data, error } = await supabase.rpc('redeem_customer_points', {
                    p_customer_phone: phone,
                    p_privilege_id: privilegeId
                });
                
                if (error) throw error;
                
                if (data && data.success) {
                    showResult('resultRedeem', 
                        `‚úÖ ${data.message}<br>
                         üë§ <strong>${data.customer_name}</strong><br>
                         üéÅ ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏©: <strong>${data.privilege_name}</strong><br>
                         ‚≠ê ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <strong>${data.points_redeemed} ‡πÅ‡∏ï‡πâ‡∏°</strong><br>
                         üìä ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <strong>${data.remaining_points} ‡πÅ‡∏ï‡πâ‡∏°</strong>`, 
                        true);
                    
                    document.getElementById('redeemPhone').value = '';
                    document.getElementById('privilegeSelect').value = '';
                } else {
                    showResult('resultRedeem', '‚ùå ' + (data?.message || '‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'), false);
                }
            } catch (err) {
                showResult('resultRedeem', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, false);
            }
        }
        
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        async function loadCustomers() {
            try {
                const { data, error } = await supabase
                    .from('customers')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                displayCustomers(data);
            } catch (err) {
                document.getElementById('customerList').innerHTML = 
                    '<div class="error">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
            }
        }
        
        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        async function searchCustomers() {
            const search = document.getElementById('searchCustomer').value.toLowerCase();
            
            try {
                const { data, error } = await supabase
                    .from('customers')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const filtered = data.filter(customer => 
                    customer.first_name?.toLowerCase().includes(search) ||
                    customer.last_name?.toLowerCase().includes(search) ||
                    customer.phone?.includes(search)
                );
                
                displayCustomers(filtered);
            } catch (err) {
                console.error('Search error:', err);
            }
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        function displayCustomers(customers) {
            let html = '';
            
            if (customers && customers.length > 0) {
                customers.forEach(customer => {
                    html += `
                        <div class="customer-card">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong style="font-size: 1.2em;">${customer.first_name} ${customer.last_name}</strong>
                                    <div style="color: #666; margin: 5px 0;">üì± ${customer.phone || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'}</div>
                                    <div>üÜî ‡∏ö‡∏±‡∏ï‡∏£: ${customer.card_number || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.5em; color: #4CAF50; font-weight: 700;">
                                        ${customer.points}
                                    </div>
                                    <div style="color: #666; font-size: 0.9em;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                                </div>
                            </div>
                            <div style="color: #888; font-size: 0.9em; margin-top: 10px;">
                                üìÖ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ${new Date(customer.created_at).toLocaleDateString('th-TH')}
                            </div>
                        </div>
                    `;
                });
            } else {
                html = '<div style="text-align: center; padding: 40px; color: #666;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>';
            }
            
            document.getElementById('customerList').innerHTML = html;
        }
        
        // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°
        async function loadTransactions() {
            try {
                const { data, error } = await supabase
                    .from('transactions')
                    .select(`
                        *,
                        customers (first_name, last_name, phone)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                if (error) throw error;
                
                displayTransactions(data);
            } catch (err) {
                document.getElementById('transactionList').innerHTML = 
                    '<div class="error">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
            }
        }
        
        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°
        async function searchTransactions() {
            const search = document.getElementById('searchTransaction').value;
            const type = document.getElementById('transactionType').value;
            
            try {
                let query = supabase
                    .from('transactions')
                    .select(`
                        *,
                        customers (first_name, last_name, phone)
                    `)
                    .order('created_at', { ascending: false });
                
                if (type) {
                    query = query.eq('type', type);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                const filtered = search ? data.filter(t => 
                    t.customers && t.customers.phone && t.customers.phone.includes(search)
                ) : data;
                
                displayTransactions(filtered);
            } catch (err) {
                console.error('Search transactions error:', err);
            }
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°
        function displayTransactions(transactions) {
            let html = '';
            
            if (transactions && transactions.length > 0) {
                transactions.forEach(t => {
                    const customerName = t.customers ? 
                        `${t.customers.first_name} ${t.customers.last_name}` : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö';
                    const phone = t.customers ? t.customers.phone : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö';
                    const isEarn = t.type === 'earn';
                    
                    html += `
                        <div class="transaction-card ${isEarn ? 'transaction-earn' : 'transaction-redeem'}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div>
                                    <strong>${isEarn ? '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô' : 'üéÅ ‡πÅ‡∏•‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô'}</strong>
                                    <div style="color: #666; font-size: 0.9em;">üë§ ${customerName} (${phone})</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.3em; font-weight: 700; color: ${isEarn ? '#4CAF50' : '#FF9800'}">
                                        ${isEarn ? '+' : '-'}${isEarn ? t.points_earned : t.points_redeemed}
                                    </div>
                                    <div style="color: #666; font-size: 0.8em;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                                </div>
                            </div>
                            <div style="color: #666;">üìù ${t.description || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}</div>
                            <div style="color: #888; font-size: 0.85em; margin-top: 8px;">
                                üìÖ ${new Date(t.created_at).toLocaleString('th-TH')}
                            </div>
                        </div>
                    `;
                });
            } else {
                html = '<div style="text-align: center; padding: 40px; color: #666;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</div>';
            }
            
            document.getElementById('transactionList').innerHTML = html;
        }
        
        // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
        async function loadStats() {
            try {
                const { data: customers } = await supabase.from('customers').select('points');
                const { data: transactions } = await supabase.from('transactions').select('*');
                const { data: recent } = await supabase
                    .from('transactions')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
                const totalCustomers = customers?.length || 0;
                const totalPoints = customers?.reduce((sum, c) => sum + (c.points || 0), 0) || 0;
                const avgPoints = totalCustomers > 0 ? Math.round(totalPoints / totalCustomers) : 0;
                const totalTransactions = transactions?.length || 0;
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
                const statsHtml = `
                    <div class="stat-card">
                        <div class="stat-value">${totalCustomers}</div>
                        <div class="stat-label">üë• ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalPoints}</div>
                        <div class="stat-label">‚≠ê ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${avgPoints}</div>
                        <div class="stat-label">üìä ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalTransactions}</div>
                        <div class="stat-label">üìà ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</div>
                    </div>
                `;
                
                document.getElementById('statsContainer').innerHTML = statsHtml;
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                let recentHtml = '';
                if (recent && recent.length > 0) {
                    recent.forEach(t => {
                        recentHtml += `
                            <div style="padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;">
                                <div>
                                    <div>${t.description?.substring(0, 30)}${t.description?.length > 30 ? '...' : ''}</div>
                                    <div style="font-size: 0.85em; color: #888;">
                                        ${new Date(t.created_at).toLocaleDateString('th-TH')}
                                    </div>
                                </div>
                                <div style="color: ${t.type === 'earn' ? '#4CAF50' : '#FF9800'}; font-weight: 500;">
                                    ${t.type === 'earn' ? '+' : '-'}${t.type === 'earn' ? t.points_earned : t.points_redeemed}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    recentHtml = '<div style="text-align: center; padding: 20px; color: #666;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>';
                }
                
                document.getElementById('recentTransactions').innerHTML = recentHtml;
            } catch (err) {
                console.error('Error loading stats:', err);
            }
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        function showResult(elementId, message, isSuccess) {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = 'result ' + (isSuccess ? 'success' : 'error');
            
            setTimeout(() => {
                element.innerHTML = '';
                element.className = 'result';
            }, 5000);
        }
    </script>
</body>
  </html>
